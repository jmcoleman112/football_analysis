<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Video Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .teams-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .team-config {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .team-config h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .confidence-config {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            margin-top: 20px;
        }

        .confidence-config h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .confidence-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        input[type="range"] {
            width: 100%;
        }

        .range-value {
            display: inline-block;
            min-width: 40px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 30px;
            display: none;
        }
        /* show container when JS toggles 'active' */
        .video-container.active {
            display: block;
        }
        /* main video large, projection vertical sidebar on the right */
        .video-grid {
            display: grid;
            grid-template-columns: 2fr 320px;
            gap: 12px;
            padding: 10px;
            align-items: start;
        }
        .video-box {
            background: #000;
            border-radius: 8px;
            padding: 4px;
        }
        .video-box img {
            width: 100%;
            height: auto;
            display: block;
        }
        /* narrow projection box: make image fit vertically */
        .projection-box img {
            width: 100%;
            height: calc(100vh - 320px);
            object-fit: contain;
            display: block;
        }
        .possession {
            margin-top: 12px;
            color: #fff;
            font-weight: 600;
            text-align: center;
        }
        .possession-bar {
            width: 100%;
            height: 24px;
            background: rgba(255,255,255,0.12);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
            display: flex;
        }
        .possession-left, .possession-right {
            height: 100%;
            transition: width 0.25s ease;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status.processing {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚽ Football Video Analysis</h1>
            <p>Upload your football match video for real-time analysis</p>
        </div>

        <div class="content">
            <div class="upload-section">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="videoFile">Select Video File</label>
                        <input type="file" id="videoFile" name="video" accept="video/*" required>
                        <p class="info-text">Supported formats: MP4, AVI, MOV, MKV (Max: 500MB)</p>
                    </div>

                    <div class="teams-config">
                        <div class="team-config">
                            <h3>Team 1 Configuration</h3>
                            <div class="form-group">
                                <label>Team Name</label>
                                <input type="text" name="club1_name" value="Ireland">
                            </div>
                            <div class="form-group">
                                <label>Jersey Color (R,G,B)</label>
                                <input type="text" name="club1_color" value="199,207,198" placeholder="e.g., 199,207,198">
                            </div>
                            <div class="form-group">
                                <label>Goalkeeper Color (R,G,B)</label>
                                <input type="text" name="club1_gk_color" value="11,136,194" placeholder="e.g., 11,136,194">
                            </div>
                        </div>

                        <div class="team-config">
                            <h3>Team 2 Configuration</h3>
                            <div class="form-group">
                                <label>Team Name</label>
                                <input type="text" name="club2_name" value="Hungary">
                            </div>
                            <div class="form-group">
                                <label>Jersey Color (R,G,B)</label>
                                <input type="text" name="club2_color" value="108,38,34" placeholder="e.g., 108,38,34">
                            </div>
                            <div class="form-group">
                                <label>Goalkeeper Color (R,G,B)</label>
                                <input type="text" name="club2_gk_color" value="211,207,47" placeholder="e.g., 211,207,47">
                            </div>
                        </div>
                    </div>

                    <div class="confidence-config">
                        <h3>Model Confidence Settings</h3>
                        <div class="confidence-grid">
                            <div class="form-group">
                                <label>Object Detection Confidence: <span class="range-value" id="objConfValue">0.50</span></label>
                                <input type="range" name="obj_conf" id="objConf" min="0.1" max="0.9" step="0.05" value="0.5">
                                <p class="info-text">Confidence for detecting players, goalkeepers, referees</p>
                            </div>
                            <div class="form-group">
                                <label>Ball Detection Confidence: <span class="range-value" id="ballConfValue">0.05</span></label>
                                <input type="range" name="ball_conf" id="ballConf" min="0.01" max="0.5" step="0.01" value="0.05">
                                <p class="info-text">Confidence for detecting the ball</p>
                            </div>
                            <div class="form-group">
                                <label>Field Detection Confidence: <span class="range-value" id="fieldConfValue">0.30</span></label>
                                <input type="range" name="field_conf" id="fieldConf" min="0.1" max="0.7" step="0.05" value="0.3">
                                <p class="info-text">Confidence for detecting the field</p>
                            </div>
                            <div class="form-group">
                                <label>Keypoint Confidence: <span class="range-value" id="kpConfValue">0.70</span></label>
                                <input type="range" name="kp_conf" id="kpConf" min="0.3" max="0.9" step="0.05" value="0.7">
                                <p class="info-text">Confidence for field keypoints (corners, lines)</p>
                            </div>
                        </div>
                        <div style="margin-top:12px;">
                            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Projection Visualization</label>
                            <select name="projection_mode" id="projectionModeSelect" style="width:100%; padding:10px; border-radius:8px; border:2px solid #ddd;">
                                <option value="heatmap" selected>Heatmap</option>
                                <option value="voronoi">Voronoi</option>
                                <option value="both">Both (heatmap + voronoi)</option>
                            </select>

                            <!-- Draw keypoints toggle -->
                            <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
                                <input type="checkbox" id="drawKeypoints" name="draw_keypoints" checked>
                                <label for="drawKeypoints" style="font-weight:600; color:#333;">Draw keypoints on video</label>
                            </div>

                            <!-- New: Processing Mode selector -->
                            <div style="margin-top:12px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Processing Mode</label>
                                <select name="processing_mode" id="processingModeSelect" style="width:100%; padding:10px; border-radius:8px; border:2px solid #ddd;">
                                    <option value="quality" selected>Mode A (Quality) — detect every frame</option>
                                    <option value="balanced">Mode B (Balanced) — detect every 3rd frame, track between</option>
                                    <option value="speed">Mode C (Speed) — detect every 5th frame, track between</option>
                                </select>
                            </div>

                            <!-- New: Input resolution scale slider -->
                            <div style="margin-top:12px;">
                                <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Input Resolution Scale: <span id="scaleValue">100%</span></label>
                                <input type="range" id="resolutionScale" name="input_scale" min="0.25" max="1.0" step="0.05" value="1.0">
                                <p class="info-text">Lower values speed up processing at the cost of detection detail.</p>
                            </div>
                        </div>
                    </div>

                    <div class="controls">
                        <button type="submit" class="btn btn-primary">Start Analysis</button>
                    </div>
                </form>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Initializing models and processing video...</p>
            </div>

            <div class="status" id="status"></div>

            <div class="video-container" id="videoContainer">
                <div class="video-grid">
                    <div class="video-box">
                        <h3 style="color:white; text-align:center; margin:8px 0 4px 0;">Camera View</h3>
                        <img id="videoStream" src="" alt="Video Stream">
                    </div>
                    <div class="video-box projection-box">
                        <h3 style="color:white; text-align:center; margin:8px 0 4px 0;">Position Map</h3>
                        <img id="projectionStream" src="" alt="Projection Stream">
                        <div class="possession" id="possessionUI">
                            <div>Possession</div>
                            <div class="possession-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <div id="posLeft" class="possession-left" style="background:#4caf50; width:50%"></div>
                                <div id="posRight" class="possession-right" style="background:#f44336; width:50%"></div>
                            </div>
                            <div style="margin-top:6px;"><span id="posLeftText">50%</span> — <span id="posRightText">50%</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls" id="streamControls" style="display: none;">
                <button class="btn btn-danger" onclick="stopProcessing()">Stop Processing</button>
            </div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const videoContainer = document.getElementById('videoContainer');
        const videoStream = document.getElementById('videoStream');
        const projectionStream = document.getElementById('projectionStream');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const streamControls = document.getElementById('streamControls');
        const posLeft = document.getElementById('posLeft');
        const posRight = document.getElementById('posRight');
        const posLeftText = document.getElementById('posLeftText');
        const posRightText = document.getElementById('posRightText');
        const projectionModeSelect = document.getElementById('projectionModeSelect');
        const processingModeSelect = document.getElementById('processingModeSelect');
        const resolutionScale = document.getElementById('resolutionScale');
        const scaleValue = document.getElementById('scaleValue');

        // Update confidence slider values
        const objConf = document.getElementById('objConf');
        const objConfValue = document.getElementById('objConfValue');
        const ballConf = document.getElementById('ballConf');
        const ballConfValue = document.getElementById('ballConfValue');
        const fieldConf = document.getElementById('fieldConf');
        const fieldConfValue = document.getElementById('fieldConfValue');
        const kpConf = document.getElementById('kpConf');
        const kpConfValue = document.getElementById('kpConfValue');

        objConf.addEventListener('input', (e) => {
            objConfValue.textContent = parseFloat(e.target.value).toFixed(2);
        });
        ballConf.addEventListener('input', (e) => {
            ballConfValue.textContent = parseFloat(e.target.value).toFixed(2);
        });
        fieldConf.addEventListener('input', (e) => {
            fieldConfValue.textContent = parseFloat(e.target.value).toFixed(2);
        });
        kpConf.addEventListener('input', (e) => {
            kpConfValue.textContent = parseFloat(e.target.value).toFixed(2);
        });

        // update scale label
        scaleValue.textContent = Math.round(parseFloat(resolutionScale.value) * 100) + '%';
        resolutionScale.addEventListener('input', (e) => {
            const v = parseFloat(e.target.value);
            scaleValue.textContent = Math.round(v * 100) + '%';
        });

        // Send projection mode change to server while streaming
        projectionModeSelect.addEventListener('change', async (e) => {
            const mode = e.target.value;
            try {
                await fetch('/projection_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
            } catch (err) {
                console.error('Failed to set projection mode', err);
            }
        });

        // Send processing mode change live
        processingModeSelect.addEventListener('change', async (e) => {
            const mode = e.target.value;
            try {
                await fetch('/processing_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
            } catch (err) {
                console.error('Failed to set processing mode', err);
            }
        });

        // Send input scale change live
        resolutionScale.addEventListener('change', async (e) => {
            const scale = parseFloat(e.target.value);
            try {
                await fetch('/input_scale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scale })
                });
            } catch (err) {
                console.error('Failed to set input scale', err);
            }
        });

        // draw keypoints toggle sends immediate update to server
        const drawKeypointsCheckbox = document.getElementById('drawKeypoints');
        drawKeypointsCheckbox.addEventListener('change', async (e) => {
            const draw = e.target.checked;
            try {
                await fetch('/draw_keypoints', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ draw })
                });
            } catch (err) {
                console.error('Failed to set draw_keypoints', err);
            }
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(uploadForm);

            // Show loading
            loading.classList.add('active');
            status.className = 'status';
            status.style.display = 'none';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                loading.classList.remove('active');

                if (response.ok) {
                    status.className = 'status processing';
                    status.textContent = '✓ Processing started! Video stream will appear below...';

                    // Start video stream
                    setTimeout(() => {
                        videoStream.src = '/video_feed?' + new Date().getTime();
                        projectionStream.src = '/projection_feed?' + new Date().getTime();
                        videoContainer.classList.add('active');
                        streamControls.style.display = 'flex';

                        // after starting, push live processing_mode and input_scale to server
                        (async () => {
                            try {
                                await fetch('/processing_mode', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ mode: processingModeSelect.value })
                                });
                                await fetch('/input_scale', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ scale: parseFloat(resolutionScale.value) })
                                });
                            } catch (e) {
                                console.warn('Failed to push live mode/scale', e);
                            }
                        })();

                    }, 1000);

                } else {
                    status.className = 'status error';
                    status.textContent = '✗ Error: ' + result.error;
                }
            } catch (error) {
                loading.classList.remove('active');
                status.className = 'status error';
                status.textContent = '✗ Error: ' + error.message;
            }
        });

        async function stopProcessing() {
            try {
                const response = await fetch('/stop', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    status.className = 'status';
                    status.textContent = 'Processing stopped';
                    videoContainer.classList.remove('active');
                    streamControls.style.display = 'none';
                }
            } catch (error) {
                console.error('Error stopping processing:', error);
            }
        }

        // Poll possession endpoint to update UI
        setInterval(async () => {
            try {
                const resp = await fetch('/possession');
                if (resp.ok) {
                    const p = await resp.json();
                    // normalize and compute integer percent for left
                    const leftPct = Math.round((p.club1 || 0.5) * 100);
                    const rightPct = 100 - leftPct; // ensure fills exactly 100%

                    // apply widths
                    posLeft.style.width = leftPct + '%';
                    posRight.style.width = rightPct + '%';

                    // apply colors if provided
                    if (p.club1_color) posLeft.style.background = p.club1_color;
                    if (p.club2_color) posRight.style.background = p.club2_color;

                    // update texts
                    posLeftText.textContent = leftPct + '%';
                    posRightText.textContent = rightPct + '%';
                }
            } catch (e) {
                // ignore polling errors
            }
        }, 1000);

        // Poll processing status
        setInterval(async () => {
             try {
                 const response = await fetch('/status');
                 const result = await response.json();

                 if (!result.processing && videoContainer.classList.contains('active')) {
                     // Processing finished
                     setTimeout(() => {
                         videoContainer.classList.remove('active');
                         streamControls.style.display = 'none';
                         status.className = 'status';
                         status.textContent = 'Processing complete!';
                     }, 2000);
                 }
             } catch (error) {
                 console.error('Error checking status:', error);
             }
        }, 2000);
    </script>
</body>
</html>
